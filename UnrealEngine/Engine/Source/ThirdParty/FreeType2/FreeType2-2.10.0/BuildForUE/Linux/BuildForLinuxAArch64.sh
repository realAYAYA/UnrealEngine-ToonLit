#!/bin/bash

set -eu

SCRIPT_DIR=$(cd "$(dirname "$BASH_SOURCE")" ; pwd)
UE_THIRD_PARTY_DIR=$(cd "${SCRIPT_DIR}/../../../.."; pwd)
FREETYPE_DIR=$(cd "${SCRIPT_DIR}/../.."; pwd)

CFLAGS="-ffunction-sections -fdata-sections"

# Get num of cores
export CORES=$(getconf _NPROCESSORS_ONLN)
echo "Using ${CORES} cores for building"

BuildLibFreeType2()
{
    export ARCH=$1
    export FLAVOR=$2
    local EXT=$3
    local BUILD_DIR=/tmp/Build-FreeType2-${ARCH}-${FLAVOR}

    echo "Building ${ARCH} ${FLAVOR}"
    rm -rf ${BUILD_DIR}
    mkdir -p ${BUILD_DIR}

    pushd ${BUILD_DIR}

    set -x
    cmake \
      -DCMAKE_TOOLCHAIN_FILE="/tmp/__cmake_toolchain.cmake" \
      -DCMAKE_MAKE_PROGRAM=$(which make) \
      -DCMAKE_BUILD_TYPE=${FLAVOR} \
      -DZLIB_LIBRARY="${UE_THIRD_PARTY_DIR}/zlib/v1.2.8/lib/Linux/${ARCH}/libz_fPIC.a" \
      -DZLIB_INCLUDE_DIR="${UE_THIRD_PARTY_DIR}/zlib/v1.2.8/include/Linux/${ARCH}" \
      -DPNG_LIBRARY="${UE_THIRD_PARTY_DIR}/libPNG/libPNG-1.5.27/lib/Linux/${ARCH}/libpng.a" \
      -DPNG_PNG_INCLUDE_DIR="${UE_THIRD_PARTY_DIR}/libPNG/libPNG-1.5.27" \
      -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
      -DCMAKE_C_FLAGS="$CFLAGS" \
      ${FREETYPE_DIR}
    set +x

    VERBOSE=1 make -j ${CORES}

    mkdir -p ${FREETYPE_DIR}/lib/Linux/${ARCH}
    cp -v ${BUILD_DIR}/libfreetype${EXT}.a ${FREETYPE_DIR}/lib/Linux/${ARCH}/libfreetype${EXT}_fPIC.a

    popd
}

( cat <<_EOF_
  ## autogenerated by ${BASH_SOURCE} script
  SET(LINUX_MULTIARCH_ROOT \$ENV{LINUX_MULTIARCH_ROOT})
  SET(ARCHITECTURE_TRIPLE \$ENV{ARCH})

  message (STATUS "LINUX_MULTIARCH_ROOT is '\${LINUX_MULTIARCH_ROOT}'")
  message (STATUS "ARCHITECTURE_TRIPLE is '\${ARCHITECTURE_TRIPLE}'")

  SET(CMAKE_CROSSCOMPILING TRUE)
  SET(CMAKE_SYSTEM_NAME Linux)
  SET(CMAKE_SYSTEM_VERSION 1)

  # sysroot
  SET(CMAKE_SYSROOT \${LINUX_MULTIARCH_ROOT}/\${ARCHITECTURE_TRIPLE})

  SET(CMAKE_LIBRARY_ARCHITECTURE \${ARCHITECTURE_TRIPLE})

  # specify the cross compiler
  SET(CMAKE_C_COMPILER            \${CMAKE_SYSROOT}/bin/clang)
  SET(CMAKE_C_COMPILER_TARGET     \${ARCHITECTURE_TRIPLE})
  SET(CMAKE_C_FLAGS "-target      \${ARCHITECTURE_TRIPLE}")

  SET(CMAKE_CXX_COMPILER          \${CMAKE_SYSROOT}/bin/clang++)
  SET(CMAKE_CXX_COMPILER_TARGET   \${ARCHITECTURE_TRIPLE})
  SET(CMAKE_CXX_FLAGS "-target    \${ARCHITECTURE_TRIPLE}")

  SET(CMAKE_ASM_COMPILER          \${CMAKE_SYSROOT}/bin/clang)

  SET(CMAKE_FIND_ROOT_PATH        \${LINUX_MULTIARCH_ROOT})

  # hoping to force it to use ar
  set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM ONLY)
  set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
  set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)

_EOF_
) > /tmp/__cmake_toolchain.cmake

BuildLibFreeType2 aarch64-unknown-linux-gnueabi Release ""
BuildLibFreeType2 aarch64-unknown-linux-gnueabi Debug "d"
