#!/bin/zsh -e
# Copyright Epic Games, Inc. All Rights Reserved.

LIBCURL_VERSION=8.4.0
OPENSSL_VERSION=1.1.1t
ZLIB_VERSION=1.3
NGHTTP2_VERSION=1.47.0
OSX_DEPLOYMENT_TARGET=10.15

LIB_ROOT=${0:a:h:h:h}
THIRDPARTY_ROOT=${LIB_ROOT:h:h}
ENGINE_ROOT=${THIRDPARTY_ROOT:h:h}
CMAKE_ADDITIONAL_ARGUMENTS="-DCMAKE_C_FLAGS=\"-DNGHTTP2_STATICLIB=1\" -DUSE_NGHTTP2=ON -DCURL_USE_OPENSSL=ON -DBUILD_CURL_EXE=OFF -DCURL_DISABLE_LDAP=ON -DCURL_DISABLE_LDAPS=ON -DBUILD_SHARED_LIBS=OFF -DCMAKE_FIND_USE_SYSTEM_ENVIRONMENT_PATH=OFF -DCMAKE_OSX_DEPLOYMENT_TARGET=${OSX_DEPLOYMENT_TARGET}"
CMAKE_OPENSSL_ARGUMENTS="-DOPENSSL_CRYPTO_LIBRARY=${THIRDPARTY_ROOT}/OpenSSL/${OPENSSL_VERSION}/lib/Mac/libcrypto.a -DOPENSSL_SSL_LIBRARY=${THIRDPARTY_ROOT}/OpenSSL/${OPENSSL_VERSION}/lib/Mac/libssl.a -DOPENSSL_INCLUDE_DIR=${THIRDPARTY_ROOT}/OpenSSL/${OPENSSL_VERSION}/include/Mac -DOPENSSL_USE_STATIC_LIBS=ON"
CMAKE_ZLIB_ARGUMENTS="-DZLIB_LIBRARY=${THIRDPARTY_ROOT}/zlib/${ZLIB_VERSION}/lib/Mac/Release/libz.a -DZLIB_INCLUDE_DIR=${THIRDPARTY_ROOT}/zlib/${ZLIB_VERSION}/include"
CMAKE_NGHTTP2_ARGUMENTS="-DNGHTTP2_LIBRARY=${THIRDPARTY_ROOT}/nghttp2/${NGHTTP2_VERSION}/lib/Mac/Release/libnghttp2.a -DNGHTTP2_INCLUDE_DIR=${THIRDPARTY_ROOT}/nghttp2/${NGHTTP2_VERSION}/include"

${THIRDPARTY_ROOT}/CMake/PlatformScripts/Mac/BuildLibForMac.command ${LIB_ROOT:h:t} ${LIB_ROOT:t} --config=Release --output-name=curl --cmake-args="${CMAKE_ADDITIONAL_ARGUMENTS} ${CMAKE_OPENSSL_ARGUMENTS} ${CMAKE_ZLIB_ARGUMENTS} ${CMAKE_NGHTTP2_ARGUMENTS}"

