@echo off
setlocal

set LLVM_VERSION=12.0.1
set ISPC_VERSION=1.17.0

Set TREE_ROOT=%~dp0
Set LLVM_ROOT=%TREE_ROOT%\llvm-%LLVM_VERSION%
set ISPC_ROOT=%TREE_ROOT%\ispc-%ISPC_VERSION%

rem BUILD ISPC
Set LLVM_INSTALL=%TREE_ROOT%\llvm
Set ISPC_INSTALL=%TREE_ROOT%\ispc
set PATH=%LLVM_INSTALL%\bin;%ISPC_INSTALL%\bin;%PATH%
cd /d %ISPC_ROOT%
rmdir /s/q build
rmdir /s/q %ISPC_INSTALL%
mkdir build
cd build
Set CMAKE_OPTIONS=-DARM_ENABLED=ON
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DWASM_ENABLED=OFF
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_INCLUDE_EXAMPLES=OFF
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_INCLUDE_DPCPP_EXAMPLES=OFF
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_INCLUDE_TESTS=OFF
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_INCLUDE_BENCHMARKS=OFF
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_INCLUDE_UTILS=OFF
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_PREPARE_PACKAGE=OFF
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_CROSS=ON
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_WINDOWS_TARGET=ON
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_LINUX_TARGET=ON
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_FREEBSD_TARGET=ON
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_MACOS_TARGET=OFF
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_IOS_TARGET=ON
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_ANDROID_TARGET=ON
Set CMAKE_OPTIONS=%CMAKE_OPTIONS% -DISPC_PS_TARGET=OFF
cmake -G "Visual Studio 16" -Thost=x64 %CMAKE_OPTIONS% -DCMAKE_INSTALL_PREFIX=%ISPC_INSTALL% -DISPC_GNUWIN32_PATH=C:\cygwin64 %ISPC_ROOT%
msbuild INSTALL.vcxproj /V:m /p:Platform=x64 /p:Configuration=Release /t:rebuild

cd /d %TREE_ROOT%
p4 edit bin\Windows\ispc.exe
copy %ISPC_INSTALL%\bin\ispc.exe bin\Windows\ispc.exe
