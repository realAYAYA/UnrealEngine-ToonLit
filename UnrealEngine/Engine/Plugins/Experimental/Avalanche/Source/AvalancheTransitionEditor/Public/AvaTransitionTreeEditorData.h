// Copyright Epic Games, Inc. All Rights Reserved.

#pragma once

#include "AvaTagHandle.h"
#include "Containers/Map.h"
#include "Delegates/Delegate.h"
#include "Misc/Guid.h"
#include "State/AvaTransitionAutogeneratedStateContext.h"
#include "State/AvaTransitionStateMetadata.h"
#include "StateTreeEditorData.h"
#include "AvaTransitionTreeEditorData.generated.h"

class UAvaTransitionTreeEditorData;
class UStateTreeState;

UCLASS(MinimalAPI, HideCategories=(Common))
class UAvaTransitionTreeEditorData : public UStateTreeEditorData
{
	GENERATED_BODY()

public:
	AVALANCHETRANSITIONEDITOR_API UStateTreeState& CreateState(const UStateTreeState& InSiblingState, bool bInAfter);

	FAvaTagHandle GetTransitionLayer() const
	{
		return TransitionLayer;
	}

	void SetTransitionLayer(const FAvaTagHandle& InTransitionLayer)
	{
		TransitionLayer = InTransitionLayer;
	}

	static FName GetTransitionLayerPropertyName()
	{
		return GET_MEMBER_NAME_CHECKED(UAvaTransitionTreeEditorData, TransitionLayer);
	}

	const FAvaTransitionStateMetadata* FindStateMetadata(const FGuid& InStateId) const
	{
		return StateMetadata.Find(InStateId);
	}

	FAvaTransitionStateMetadata& FindOrAddStateMetadata(const FGuid& InStateId)
	{
		return StateMetadata.FindOrAdd(InStateId);
	}

	const FAvaTransitionAutogeneratedStateContext* FindAutogeneratedStateContext(const FGuid& InStateId) const
	{
		return AutogeneratedStates.Find(InStateId);
	}

	bool IsAutogeneratedState(const UStateTreeState& InState, const FAvaTransitionAutogeneratedStateContext& InContext) const
	{
		const FAvaTransitionAutogeneratedStateContext* AutogeneratedContext = FindAutogeneratedStateContext(InState.ID);
		return AutogeneratedContext && AutogeneratedContext->Matches(InContext);
	}

	void SetAutogeneratedState(const FGuid& InStateId, const FAvaTransitionAutogeneratedStateContext& InContext)
	{
		AutogeneratedStates.Add(InStateId, InContext);
	}

	FSimpleMulticastDelegate& GetOnTreeRequestRefresh()
	{
		return OnTreeRequestRefresh;
	}

private:
	/** The Layer this Transition Logic Tree deals with */
	UPROPERTY(EditAnywhere, Category="Transition Logic")
	FAvaTagHandle TransitionLayer;

	/** Map of a state's id to its metadata */
	UPROPERTY()
	TMap<FGuid, FAvaTransitionStateMetadata> StateMetadata;

	/** Map of an autogenerated state's id to their context information */
	UPROPERTY()
	TMap<FGuid, FAvaTransitionAutogeneratedStateContext> AutogeneratedStates;

	FSimpleMulticastDelegate OnTreeRequestRefresh;
};
